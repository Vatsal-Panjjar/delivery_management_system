<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <h2>Delivery Dashboard</h2>
        <p>Welcome, <span id="usernameDisplay"></span>! (<span id="roleDisplay"></span>)</p>

        <div id="orderSection">
            <h3>Create New Order</h3>
            <form id="createOrderForm">
                <input type="text" id="orderDesc" placeholder="Order Description" required>
                <button type="submit">Create Order</button>
            </form>

            <h3>My Orders</h3>
            <table id="ordersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <button id="logoutBtn">Logout</button>
    </div>

    <script>
        const token = localStorage.getItem("token");
        const role = localStorage.getItem("role");
        const username = localStorage.getItem("username");
        if (!token) {
            alert("Not logged in!");
            window.location.href = "index.html";
        }

        document.getElementById("usernameDisplay").innerText = username || "User";
        document.getElementById("roleDisplay").innerText = role || "customer";

        const ordersTable = document.getElementById("ordersTable").getElementsByTagName('tbody')[0];

        async function fetchOrders() {
            const res = await fetch("/api/orders", {
                headers: { "Authorization": "Bearer " + token }
            });
            if (res.ok) {
                const orders = await res.json();
                ordersTable.innerHTML = "";
                orders.forEach(order => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${order.id}</td>
                        <td>${order.description}</td>
                        <td>${order.status}</td>
                        <td>
                            ${order.status !== 'cancelled' ? `<button onclick="cancelOrder(${order.id})">Cancel</button>` : ""}
                        </td>
                    `;
                    ordersTable.appendChild(tr);
                });
            } else {
                alert("Failed to fetch orders");
            }
        }

        async function cancelOrder(orderId) {
            const res = await fetch("/api/orders/"+orderId+"/cancel", {
                method: "POST",
                headers: { "Authorization": "Bearer " + token }
            });
            if (res.ok) {
                fetchOrders();
            } else {
                alert("Failed to cancel order");
            }
        }

        document.getElementById("createOrderForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const desc = document.getElementById("orderDesc").value;
            const res = await fetch("/api/orders", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ description: desc })
            });
            if (res.ok) {
                document.getElementById("orderDesc").value = "";
                fetchOrders();
            } else {
                alert("Failed to create order");
            }
        });

        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.clear();
            window.location.href = "index.html";
        });

        fetchOrders();
    </script>
</body>
</html>
